<!DOCTYPE html>
<html>
<head>
    <title>Server Status Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-list { display: flex; flex-direction: column; gap: 15px; }
        .server-row { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; }
        .server-favicon { width: 20px; height: 20px; margin: 0 15px; flex-shrink: 0; }
        .server-info { flex: 1; display: flex; gap: 40px; }
        .server-col { flex: 1; }
        .server-chart { width: 300px; height: 70px; margin-left: 20px; }
        .status-up { border-left: 4px solid #4CAF50; }
        .status-down { border-left: 4px solid #f44336; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .up { background: #4CAF50; }
        .down { background: #f44336; }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 20px; text-decoration: none; color: #333; font-weight: bold; }
        .nav a.active { color: #2196F3; }
        button { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976D2; }
        .login-form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        .auth-status { float: right; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Server Status Dashboard</h1>
            <div class="nav">
                <a href="#" onclick="showDashboard()" class="active" id="dashboard-link">Dashboard</a>
                <a href="#" onclick="showAdmin()" id="admin-link" style="display: none;">Admin</a>
                <div class="auth-status">
                    <span id="auth-status">Guest Mode</span>
                    <button onclick="showLogin()" id="login-btn">Login</button>
                    <button onclick="logout()" id="logout-btn" style="display: none;">Logout</button>
                </div>
            </div>
        </div>

        <div id="dashboard-view">
            <div id="status-list" class="status-list"></div>
        </div>

        <div id="login-view" style="display: none;">
            <div class="login-form">
                <h2>Admin Login</h2>
                <form id="login-form">
                    <div style="margin-bottom: 15px;">
                        <label>Password:</label><br>
                        <input type="password" id="password" required style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <button type="submit">Login</button>
                </form>
            </div>
        </div>

        <div id="admin-view" style="display: none;">
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2>Add Server</h2>
                <form id="add-server-form">
                    <div style="margin-bottom: 15px;">
                        <label>Server Name:</label><br>
                        <input type="text" id="server-name" required style="width: 300px; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Server URL:</label><br>
                        <input type="url" id="server-url" required style="width: 300px; padding: 8px; margin-top: 5px;">
                    </div>
                    <button type="submit">Add Server</button>
                </form>
                
                <h2 style="margin-top: 30px;">Manage Servers</h2>
                <div id="server-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('authToken');
        
        function getAuthHeaders() {
            return authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
        }
        
        function updateAuthUI() {
            const isLoggedIn = !!authToken;
            document.getElementById('auth-status').textContent = isLoggedIn ? 'Admin Mode' : 'Guest Mode';
            document.getElementById('login-btn').style.display = isLoggedIn ? 'none' : 'inline-block';
            document.getElementById('logout-btn').style.display = isLoggedIn ? 'inline-block' : 'none';
            document.getElementById('admin-link').style.display = isLoggedIn ? 'inline-block' : 'none';
        }
        
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`, {
                    headers: getAuthHeaders()
                });
                const servers = await response.json();
                const isLoggedIn = !!authToken;
                
                const list = document.getElementById('status-list');
                list.innerHTML = servers.map(server => {
                    const statusClass = server.status ? 'status-up' : 'status-down';
                    const favicon = server.url ? `https://${new URL(server.url).hostname}/favicon.ico` : '';
                    
                    return `
                        <div class="server-row ${statusClass}">
                            ${favicon ? `<img src="${favicon}" class="server-favicon" alt="favicon">` : '<div class="server-favicon"></div>'}
                            <div class="server-info">
                                <div class="server-col">
                                    <h3 style="margin: 0 0 10px 0;">${server.name}</h3>
                                    ${server.url ? `<p style="margin: 5px 0;">${server.url}</p>` : ''}
                                </div>
                                <div class="server-col">
                                    ${isLoggedIn && server.responseTime !== undefined ? `<p style="margin: 0 0 10px 0;"><strong>Response Time:</strong> ${server.responseTime}ms</p>` : ''}
                                    ${isLoggedIn && server.activity !== undefined ? `<p style="margin: 0 0 10px 0;"><strong>Activity:</strong> ${server.activity}</p>` : ''}
                                    ${isLoggedIn && server.activeGames !== undefined ? `<p style="margin: 0 0 10px 0;"><strong>Active Games:</strong> ${server.activeGames}</p>` : ''}
                                    ${isLoggedIn && server.runningMatches !== undefined ? `<p style="margin: 0 0 10px 0;"><strong>Running Matches:</strong> ${server.runningMatches}</p>` : ''}
                                    <p style="margin: 5px 0;"><strong>Last Check:</strong> ${server.timestamp ? new Date(server.timestamp).toLocaleString() : 'Never'}</p>
                                </div>
                            </div>
                            ${isLoggedIn ? `<div class="server-chart"><canvas id="chart-${server.id}" width="300" height="70"></canvas></div>` : ''}
                        </div>
                    `;
                }).join('');
                
                if (isLoggedIn) loadCharts();
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }
        
        async function loadServers() {
            try {
                const response = await fetch(`${API_BASE}/servers`, {
                    headers: getAuthHeaders()
                });
                const servers = await response.json();
                
                const list = document.getElementById('server-list');
                list.innerHTML = servers.map(server => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${server.name}</strong><br>
                            <small>${server.url}</small>
                        </div>
                        <button onclick="deleteServer('${server.id}')" style="background: #f44336;">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading servers:', error);
            }
        }
        
        async function addServer(event) {
            event.preventDefault();
            
            const name = document.getElementById('server-name').value;
            const url = document.getElementById('server-url').value;
            
            try {
                await fetch(`${API_BASE}/servers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify({ name, url })
                });
                
                document.getElementById('add-server-form').reset();
                loadServers();
                alert('Server added successfully!');
            } catch (error) {
                console.error('Error adding server:', error);
                alert('Error adding server');
            }
        }
        
        async function deleteServer(id) {
            if (!confirm('Are you sure you want to delete this server?')) return;
            
            try {
                await fetch(`${API_BASE}/servers/${id}`, { 
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                loadServers();
                alert('Server deleted successfully!');
            } catch (error) {
                console.error('Error deleting server:', error);
                alert('Error deleting server');
            }
        }
        
        function showDashboard() {
            document.getElementById('dashboard-view').style.display = 'block';
            document.getElementById('admin-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('dashboard-link').classList.add('active');
            document.getElementById('admin-link').classList.remove('active');
            loadStatus();
        }
        
        function showAdmin() {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'block';
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('dashboard-link').classList.remove('active');
            document.getElementById('admin-link').classList.add('active');
            loadServers();
        }
        
        function showLogin() {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';
        }
        
        async function login(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    updateAuthUI();
                    showDashboard();
                    alert('Login successful!');
                } else {
                    alert('Invalid password');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
            }
        }
        
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            updateAuthUI();
            showDashboard();
        }
        
        document.getElementById('add-server-form').addEventListener('submit', addServer);
        document.getElementById('login-form').addEventListener('submit', login);
        
        updateAuthUI();
        
        async function loadCharts() {
            if (!authToken) return;
            
            const servers = await (await fetch(`${API_BASE}/status`, { headers: getAuthHeaders() })).json();
            const allHistory = [];
            const threeHoursAgo = Date.now() - (3 * 60 * 60 * 1000);
            
            // Load and filter history data to last 3 hours
            for (const server of servers) {
                const history = await (await fetch(`${API_BASE}/history/${server.id}`, { headers: getAuthHeaders() })).json();
                const filtered = history.filter(h => new Date(h.timestamp).getTime() >= threeHoursAgo);
                allHistory.push({ serverId: server.id, data: filtered });
            }
            
            // Calculate global max for consistent scaling
            const globalMaxResponse = Math.max(...allHistory.flatMap(h => h.data.map(d => d.responseTime)));
            const globalMaxActivity = Math.max(...allHistory.flatMap(h => h.data.filter(d => d.activity !== undefined).map(d => d.activity)));
            const globalMaxGames = Math.max(...allHistory.flatMap(h => h.data.filter(d => d.activeGames !== undefined).map(d => d.activeGames)));
            const globalMaxMatches = Math.max(...allHistory.flatMap(h => h.data.filter(d => d.runningMatches !== undefined).map(d => d.runningMatches)));
            
            // Draw all charts with consistent scaling and time range
            for (const { serverId, data } of allHistory) {
                drawChart(serverId, data, { response: globalMaxResponse, activity: globalMaxActivity, games: globalMaxGames, matches: globalMaxMatches }, threeHoursAgo);
            }
        }
        
        function drawChart(serverId, data, globalMax, startTime) {
            const canvas = document.getElementById(`chart-${serverId}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            if (data.length < 1) return;
            
            const timeRange = 3 * 60 * 60 * 1000; // 3 hours
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 1; i < 4; i++) {
                const y = (i / 4) * height;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            for (let i = 1; i < 6; i++) {
                const x = (i / 6) * width;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Draw response time (blue)
            const maxResponse = globalMax.response || Math.max(...data.map(d => d.responseTime));
            if (maxResponse > 0) {
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                data.forEach((point, i) => {
                    const pointTime = new Date(point.timestamp).getTime();
                    const x = ((pointTime - startTime) / timeRange) * width;
                    const y = height - (point.responseTime / maxResponse) * height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                
                ctx.stroke();
            }
            
            // Draw activity (green) if available
            const activityData = data.filter(d => d.activity !== undefined);
            if (activityData.length > 0) {
                const maxActivity = globalMax.activity || Math.max(...activityData.map(d => d.activity));
                if (maxActivity > 0) {
                    ctx.strokeStyle = '#4CAF50';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    activityData.forEach((point, i) => {
                        const pointTime = new Date(point.timestamp).getTime();
                        const x = ((pointTime - startTime) / timeRange) * width;
                        const y = height - (point.activity / maxActivity) * height;
                        
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    
                    ctx.stroke();
                }
            }
            
            // Draw active games (orange) if available
            const gamesData = data.filter(d => d.activeGames !== undefined);
            if (gamesData.length > 0) {
                const maxGames = globalMax.games || Math.max(...gamesData.map(d => d.activeGames));
                if (maxGames > 0) {
                    ctx.strokeStyle = '#FF9800';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    gamesData.forEach((point, i) => {
                        const pointTime = new Date(point.timestamp).getTime();
                        const x = ((pointTime - startTime) / timeRange) * width;
                        const y = height - (point.activeGames / maxGames) * height;
                        
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    
                    ctx.stroke();
                }
            }
            
            // Add labels and legend
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            
            // Response time legend
            ctx.fillStyle = '#2196F3';
            ctx.fillText('Response', 5, 15);
            ctx.fillStyle = '#666';
            ctx.fillText(`${maxResponse}ms`, 50, 15);
            
            // Activity legend if available
            if (activityData.length > 0) {
                ctx.fillStyle = '#4CAF50';
                ctx.fillText('Activity', 5, 30);
                ctx.fillStyle = '#666';
                ctx.fillText(`${globalMax.activity || 0}`, 50, 30);
            }
            
            // Games legend if available
            if (gamesData.length > 0) {
                ctx.fillStyle = '#FF9800';
                ctx.fillText('Games', 5, 45);
                ctx.fillStyle = '#666';
                ctx.fillText(`${globalMax.games || 0}`, 50, 45);
            }
            
            // Running matches (purple) if available
            const matchesData = data.filter(d => d.runningMatches !== undefined);
            if (matchesData.length > 0) {
                const maxMatches = globalMax.matches || Math.max(...matchesData.map(d => d.runningMatches));
                if (maxMatches > 0) {
                    ctx.strokeStyle = '#9C27B0';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    matchesData.forEach((point, i) => {
                        const pointTime = new Date(point.timestamp).getTime();
                        const x = ((pointTime - startTime) / timeRange) * width;
                        const y = height - (point.runningMatches / maxMatches) * height;
                        
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    
                    ctx.stroke();
                }
                
                // Matches legend
                ctx.fillStyle = '#9C27B0';
                ctx.fillText('Matches', 5, 60);
                ctx.fillStyle = '#666';
                ctx.fillText(`${globalMax.matches || 0}`, 50, 60);
            }
        }
        
        // Load initial data
        loadStatus();
        setInterval(loadStatus, 300000);
    </script>
</body>
</html>